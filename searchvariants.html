<html>
<head>
    <title>Thousand Genomes Variant Set Demo</title>
    <script src="https://code.jquery.com/jquery-1.12.3.min.js"   integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ="   crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <style>
    .H { color:#FFFFFF; font-weight:bold; }
    .C { color:#909090; font-weight:bold; }
    .O { color:#FF0D0D; font-weight:bold; }
    .N { color:#3050F8; font-weight:bold; }
    .P { color:#FF8000; font-weight:bold; }

    .A { color:#5050ff; font-weight:bold; }
    .G { color:#00c000; font-weight:bold; }
    .Cy { color:#e00000; font-weight:bold; }
    .T { color:#b6b600; font-weight:bold; }
    .dna { color:#ae00fe; font-weight:bold; }
    .bar rect {
      fill: steelblue;
      shape-rendering: crispEdges;
    }

    .bar text {
      fill: #fff;
    }

    .axis path, .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }
    #graph {
      font-size: 8pt;
    }
    </style>
    <script src="//d3js.org/d3.v3.min.js"></script>
</head>
<body style="padding-left: 0%; padding-right: 0%; font-family: sans-serif; margin: 0; padding: 0">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="URL" id="url" value="http://1kgenomes.ga4gh.org/">
          <input type="text" class="form-control" placeholder="Variant Set ID" id="variantSetId" value="WyIxa2dlbm9tZXMiLCJ2cyIsInJlbGVhc2UiXQ">
          <input type="text" class="form-control" placeholder="start" id="start" value="0">
          <input type="text" class="form-control" placeholder="stop" id="stop" value="10000000">
          <input type="text" class="form-control" placeholder="referenceName" id="referenceName" value="1">
        </div>
        <button class="btn btn-default" onmouseup="start()">Submit</button>
      </div>
    </div>
  </nav>
<div class="container-fluid">
  <div id="graph">
  </div>
  <table id="variants" class="table-hover table-striped table-condensed table">
    <tr margin="padding: 5px">
      <th>Chrom</th>
      <th>Pos</th>
      <th>Names</th>
      <th>Reference</th>
      <th>Alts</th>
      <th>Allele frequency</th>
      <th style="width: 4em">Link</th>
    </tr>
    <tr>
      <td colspan="7" id="placeh">No results to show</td>
  </table>
</div?>
<script>

function variantRow(variant) {
  var html = "<tr>";
  html += "<td>" + variant.referenceName + "</td>";
  html += "<td>" + variant.start + "</td>";
  html += "<td>" + variant.names + "</td>";
  var referenceBases = variant
    .referenceBases
    .replace(/A/g, "<span class='A'>A</span>")
    .replace(/T/g, "<span class='T'>T</span>")
    .replace(/G/g, "<span class='G'>G</span>")
    .replace(/C/g, "<span class='Cy'>C</span>")
  
  var alternateBases = variant
    .alternateBases.join(',')
    .replace(/A/g, "<span class='A'>A</span>")
    .replace(/T/g, "<span class='T'>T</span>")
    .replace(/G/g, "<span class='G'>G</span>")
    .replace(/C/g, "<span class='Cy'>C</span>")
  html += "<td style=\"overflow: scroll\"><small>" + referenceBases + "</small></td>";
  html += "<td style=\"overflow: scroll\"><small>" + alternateBases + "</small></td>";
  html += "<td style=\"font-family:monospace;\">" + Math.floor((10000 * variant.info["AF"])) / 100 + "%</td>";
  html += "<td><a href=\"variant.html?v=" + variant.id + "\"><span class=\"glyphicon glyphicon-link\" aria-hidden=\"true\" style=\"font-size: 8pt\"></span></a></td>";
  html += "</tr>";
  return html;
}

var alleleFrequencies = [];
function pageVariants(query) {
  var d = (new Date()).getTime();
  getVariants(query, function(res) {
    if (res.variants.length > 1) {
      $("#placeh").hide();
    }
    console.log("Got " + res.variants.length + " variants in " + ((new Date()).getTime() - d))
    res.variants.forEach(function(variant) {
      $("#variants").css("table-layout", "fixed");
      $("#variants").append(variantRow(variant));
      console.log(variant.info['AF']);
      alleleFrequencies.push(variant.info['AF']);
      console.log(bindata(alleleFrequencies));
    })
    if (res.nextPageToken) {
      var nq = query;
      nq.pageToken = res.nextPageToken;
      setTimeout(function(){ pageVariants(nq); }, 10);
    } else {
      // assuming we are served in order
      console.log("done");
    }
  })
}

function getVariants(query, callback) {
  return $.ajax(baseurl + "variants/search", {
      data : JSON.stringify(query),
      contentType : 'application/json',
      type : 'POST',
      success: callback,
      dataType: 'json'
  });
}
function start() {
  var variantSetId = $('#variantSetId').val();
  var start = Number($('#start').val());
  var cstop = Number($('#stop').val());
  var referenceName = $('#referenceName').val();
  baseurl = $('#url').val();
  var query = {"variantSetId": variantSetId,
      "start": start,
      "end": cstop,
      "referenceName": referenceName,
      "pageSize": 8,
      "callSetIds": []
    };
  pageVariants(query);
}

var width = 500;
var height = 200;
var margin = {top: 10, right: 30, bottom: 30, left: 30};
var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var x = d3.scale.linear()
    .domain([0, 1])
    .range([0, width]);

var y = d3.scale.linear()
    .domain([0, 1])
    .range([height, 0]);

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function draw(data) {
  var bar = svg.selectAll(".bar")
      .data(data)
    .enter().append("g")
      .attr("class", "bar")
      .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });
  
  bar.append("rect")
      .attr("x", 1)
      .attr("width", x(data[0].dx) - 1)
      .attr("height", function(d) { return height - y(d.y); });

  bar.append("text")
      .attr("dy", ".75em")
      .attr("y", 6)
      .attr("x", x(data[0].dx) / 2)
      .attr("text-anchor", "middle")
      .text(function(d) { return formatCount(d.y); });

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);
}

function bindata(data) {
  return d3.layout.histogram()
          .bins(x.ticks(20))(data)
}

</script>